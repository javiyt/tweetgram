on:
  workflow_dispatch: # on button click
name: Build and Deploy
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17.1
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Generate env file
      run: 'echo "$ENV_FILE" > cmd/env'
      shell: bash
      env:
        ENV_FILE: ${{secrets.ENV}}      
    - name: Generate env.test file
      run: 'echo "$ENV_TEST_FILE" > cmd/env.test'
      shell: bash
      env:
        ENV_TEST_FILE: ${{secrets.ENV_TEST}}      
    - name: Build Binary
      run: go build -o tweetgram cmd/main.go
    - name: Find and Replace
      uses: jacobtomlinson/gha-find-replace@master
      with:
        find: "/home/tweetgram/bin"
        replace: ${{secrets.FOLDER}}
        include: "system/"
    - name: Copy binary
      uses: appleboy/scp-action@master
      with:
        host: ${{secrets.HOST}}
        username: ${{secrets.USERNAME}}
        key: ${{secrets.SSHKEY}}
        port: ${{secrets.PORT}}
        passphrase: ${{secrets.PASSPHRASE}}
        source: tweetgram
        target: ${{secrets.FOLDER}}
    - name: Copy system file
      uses: appleboy/scp-action@master
      with:
        host: ${{secrets.HOST}}
        username: ${{secrets.USERNAME}}
        key: ${{secrets.SSHKEY}}
        port: ${{secrets.PORT}}
        passphrase: ${{secrets.PASSPHRASE}}
        source: system/bot.service
        target: /home/${{secrets.USERNAME}}/.config/systemd/user/
    - name: Run new bot version
      uses: appleboy/ssh-action@master
      with:
        host: ${{secrets.HOST}}
        username: ${{secrets.USERNAME}}
        key: ${{secrets.SSHKEY}}
        port: ${{secrets.PORT}}
        passphrase: ${{secrets.PASSPHRASE}}
        script: |
          systemctl --user stop bot.service   
          systemctl --user daemon-reload
          systemctl --user start bot.service   
          systemctl --user status bot.service